<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>אפליקציית ח.סבן</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>CRM - הזמנות לקוח</h1>
            <div id="customer-id-display"></div>
        </header>

        <section id="active-order" class="order-box">
            <h2>הזמנה פעילה</h2>
            <div class="order-info">
                <span id="arrival-time"></span>
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="order-buttons">
                    <button class="action-btn" id="replace-btn">החלפת מכולה</button>
                    <button class="action-btn" id="clear-btn">פינוי</button>
                </div>
            </div>
        </section>

        <section id="order-history" class="order-box">
            <h2>היסטוריית הזמנות</h2>
            <table>
                <thead>
                    <tr>
                        <th>מספר הזמנה</th>
                        <th>תאריך</th>
                        <th>סטטוס</th>
                        <th>הערות</th>
                    </tr>
                </thead>
                <tbody id="history-table"></tbody>
            </table>
        </section>

        <section id="charts" class="order-box">
            <h2>תרשים סטטוס הזמנות</h2>
            <canvas id="statusChart"></canvas>
        </section>

        <button id="scroll-top" class="scroll-btn">▲ למעלה</button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const customerId = urlParams.get('id');
        document.getElementById('customer-id-display').innerText = `לקוח: ${customerId}`;

        const sheetId = '1TPwAP0h05IyzvusybJv3zMKSOKpFNUS9jZtEK5pSgps'; // עדכן למזהה הגיליון שלך
        const sheetName = 'מעקב';

        const API_URL = `https://script.google.com/macros/s/AKfycbysLbw_ca0RhYgT498bc82oUnQ1mU8iwI-UWcLX_dW3UsUo5HEt47khZwqcYr5fAhEY/exec`;

        async function fetchOrders() {
            const response = await fetch(`${API_URL}?action=getOrdersByCustomer&id=${customerId}`);
            const data = await response.json();
            return data;
        }

        function startProgressTimer(endTime) {
            const progressBar = document.getElementById('progress-bar');
            function update() {
                const now = new Date();
                const total = new Date(endTime) - now;
                const percent = Math.max(0, Math.min(100, 100 - (total / (new Date(endTime) - now) * 100)));
                progressBar.style.width = percent + '%';
                if (total > 0) {
                    requestAnimationFrame(update);
                }
            }
            update();
        }

        function renderOrders(data) {
            if (!data || data.length === 0) return;

            const activeOrder = data.find(o => o.status === 'פעיל');
            if (activeOrder) {
                document.getElementById('arrival-time').innerText = `הגעה משוערת: ${activeOrder.arrivalTime}`;
                startProgressTimer(activeOrder.endTime);
            }

            const historyTable = document.getElementById('history-table');
            historyTable.innerHTML = '';
            data.forEach(order => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${order.orderNumber}</td>
                    <td>${order.date}</td>
                    <td>${order.status}</td>
                    <td>${order.notes}</td>
                `;
                historyTable.appendChild(tr);
            });

            const ctx = document.getElementById('statusChart').getContext('2d');
            const statusCounts = data.reduce((acc, order) => {
                acc[order.status] = (acc[order.status] || 0) + 1;
                return acc;
            }, {});
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        label: 'מספר הזמנות',
                        data: Object.values(statusCounts),
                        backgroundColor: '#0ff'
                    }]
                },
                options: { plugins: { legend: { display: false } }, responsive: true }
            });
        }

        fetchOrders().then(renderOrders);

        document.getElementById('scroll-top').addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    </script>
</body>
</html>
