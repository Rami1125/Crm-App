<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>אזור אישי - ח.סבן</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="https://i.postimg.cc/2SbDgD1B/1.png">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js"></script>

    <style>
        :root {
            --brand-primary: #0a67ad; --brand-secondary: #004272;
            --background-light: #f4f7fa; --background-white: #ffffff;
            --text-primary: #1a253c; --text-secondary: #5a647b;
            --border-color: #e8edf3; --shadow-light: 0 4px 20px rgba(0, 0, 0, 0.06);
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        body { font-family: 'Assistant', sans-serif; background-color: var(--background-light); margin: 0; color: var(--text-primary); }
        
        /* Login Page */
        #page-login { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: var(--brand-secondary); }
        .login-card { background: var(--background-white); padding: 40px; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; animation: fadeIn 0.5s; }
        .login-logo { width: 100px; margin-bottom: 20px; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 20px; }
        .btn-primary { background: var(--brand-primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; }
        
        /* App Structure */
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .page { display: none; padding: 20px; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        .app-header { display: flex; align-items: center; justify-content: space-between; padding: 0 20px; height: 60px; background: var(--background-white); box-shadow: var(--shadow-light); }
        .user-info { display: flex; align-items: center; gap: 12px; font-weight: 600; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .logout-btn { background: none; border: none; font-size: 20px; color: var(--text-secondary); cursor: pointer; }
        .splash-screen { position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; background-color: var(--brand-secondary); z-index: 9999; transition: opacity 0.5s; }
        .splash-screen.hidden { opacity: 0; pointer-events: none; }
        
        /* Project Filter */
        .filter-container { margin-bottom: 20px; }
        .filter-container select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 16px; }

        /* Order Card */
        .order-card { background:white; padding:15px; border-radius:10px; margin-bottom:10px; box-shadow: var(--shadow-light); border-left: 5px solid var(--brand-primary); }
        .order-card strong { font-size: 1.1em; }
        .order-card .project-name { font-size: 0.9em; color: var(--text-secondary); margin-top: 5px; }
    </style>
</head>
<body>

    <div id="page-login" class="page active">
        <div class="login-card">
            <img src="https://i.postimg.cc/2SbDgD1B/1.png" alt="לוגו" class="login-logo">
            <h2>אזור אישי</h2>
            <form id="login-form">
                <div class="input-group">
                    <input type="text" id="client-id" placeholder="הזן מספר לקוח ראשי" required>
                </div>
                <button type="submit" class="btn-primary">התחבר</button>
            </form>
        </div>
    </div>
    
    <div id="app-content" style="display: none;">
        <div class="app-container">
            <header class="app-header">
                <div class="user-info">
                    <img id="user-avatar" src="" alt="פרופיל" class="user-avatar">
                    <span id="user-name"></span>
                </div>
                <button class="logout-btn" id="logout-btn"><i class="fa-solid fa-right-from-bracket"></i></button>
            </header>
            <main>
                <div id="page-main" class="page">
                    <div class="filter-container">
                        <label for="project-filter" style="font-weight:600; margin-bottom:8px; display:block;">הצג פרויקט:</label>
                        <select id="project-filter"></select>
                    </div>
                    <div id="orders-list"></div>
                </div>
            </main>
        </div>
    </div>
    
    <div class="splash-screen" id="splash-screen" style="display: none;"></div>

    <script>
    (() => {
        const state = { isLoggedIn: false, client: null, orders: [], projects: [] };
        const dom = {
            loginPage: document.getElementById('page-login'),
            appContent: document.getElementById('app-content'),
            loginForm: document.getElementById('login-form'),
            clientIdInput: document.getElementById('client-id'),
            userName: document.getElementById('user-name'),
            userAvatar: document.getElementById('user-avatar'),
            logoutBtn: document.getElementById('logout-btn'),
            splashScreen: document.getElementById('splash-screen'),
            projectFilter: document.getElementById('project-filter'),
            ordersList: document.getElementById('orders-list'),
        };

        const API_URL = "https://script.google.com/macros/s/AKfycbzaPRi0t_Eln-hLL8uGzzYUhwTNEuZcogA2nbGmta8XhzEBo66N7u9ZzDJfvTWVl1RqEw/exec";
        
        async function apiPost(body) {
             try {
                // Client-side log to see what we are sending
                console.log('[CLIENT LOG] Sending to API:', body);
                const response = await fetch(API_URL, { 
                    method: 'POST', body: JSON.stringify(body), mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                const result = await response.json();
                console.log('[CLIENT LOG] Received from API:', result);
                if (result.status === 'error') throw new Error(result.message);
                return result.data;
            } catch (error) {
                alert(`שגיאת תקשורת: ${error.message}`);
                throw error;
            }
        }
        
        function initApp() {
            dom.loginForm.addEventListener('submit', handleLogin);
            dom.logoutBtn.addEventListener('click', handleLogout);
            dom.projectFilter.addEventListener('change', () => renderDashboard());
            
            const savedClientId = localStorage.getItem('saban_clientId');
            if (savedClientId) {
                dom.clientIdInput.value = savedClientId;
                handleLogin({ preventDefault: () => {} });
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const clientId = dom.clientIdInput.value.trim();
            if (!clientId) return;

            showSplashScreen();
            try {
                const data = await apiPost({ action: 'getClientData', clientId });
                state.isLoggedIn = true;
                state.client = data.client;
                state.orders = data.orders || [];
                state.projects = data.projects || [];
                localStorage.setItem('saban_clientId', clientId);
                updateUI();
            } finally {
                hideSplashScreen();
            }
        }
        
        function handleLogout() {
             localStorage.removeItem('saban_clientId');
             location.reload();
        }
        
        function updateUI() {
             if (state.isLoggedIn) {
                dom.loginPage.style.display = 'none';
                dom.appContent.style.display = 'block';
                dom.userName.textContent = state.client.name;
                dom.userAvatar.src = state.client.avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(state.client.name)}&background=004272&color=fff`;
                populateProjectFilter();
                renderDashboard();
             }
        }

        function populateProjectFilter() {
            dom.projectFilter.innerHTML = '<option value="all">כל הפרויקטים</option>';
            state.projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                dom.projectFilter.appendChild(option);
            });
        }

        function renderDashboard() {
            const selectedProjectId = dom.projectFilter.value;
            dom.ordersList.innerHTML = '';

            const filteredOrders = selectedProjectId === 'all'
                ? state.orders
                : state.orders.filter(order => String(order.projectClientId).trim() === selectedProjectId);

            if (!filteredOrders.length) {
                dom.ordersList.innerHTML = '<p>לא נמצאו הזמנות לפרויקט הנבחר.</p>';
                return;
            }
            
            filteredOrders.forEach(order => {
                const card = document.createElement('div');
                card.className = 'order-card';
                card.innerHTML = `
                    <div><strong>הזמנה #${order.id}</strong></div>
                    <div class="project-name">${order.projectName}</div>
                    <div>סטטוס: ${order.status}</div>
                `;
                dom.ordersList.appendChild(card);
            });
        }

        function showSplashScreen() {
            dom.splashScreen.style.display = 'flex';
            dom.splashScreen.classList.remove('hidden');
        }
        function hideSplashScreen() {
            setTimeout(() => dom.splashScreen.classList.add('hidden'), 500);
        }
        
        document.addEventListener('DOMContentLoaded', initApp);
    })();
    </script>
</body>
</html>

